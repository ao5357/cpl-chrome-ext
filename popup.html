<style>
body{font-family:Calibri,Arial,sans-serif;font-size:13px;min-width:360px;overflow-x:hidden;}

.cplrec{border-bottom:1px solid #b7b8bA;border-top:1px solid #fdfeff;color:#000;display:block;height:60px;text-decoration:none;}
	.cplrec:last-child{border-bottom:0;}
	.cplrec:visited{color:#800080;}
	a:hover,a.more:hover{background-color:#0067ba;color:#fff;}#cplscroller{height:62px;overflow-y:auto;width:300px;}
	.cplrec:nth-child(even){background-color:#eee;}
		.cplrec:nth-child(even):hover{background-color:#0067ba;color:#fff;}
	.cplrec:first-child{border-top:2px solid #999;}
	.cplresultimg{display:block;float:left;height:60px;margin:0 6px 0 0;padding:0;width:30px;}
		.cplresultimg img{border:0 none;height:40px;margin:5px 0 0 0;width:30px;}
	.cpltitle{display:block;padding:5px 0 0 0;font-weight:bold;}
	.cplauthor{color:#898a8c;font-size:.9em;}
		a:hover .cplauthor{color:#fff;font-weight:bold;}
a.more{background:#ccc;display:block;padding:4px 0;}
#searchform{}
	#argument{width:100%;}
	label{font-size:.7em;}
</style>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script>
$(document).ready(function(){
$("#argument").focus();
chrome.tabs.executeScript(null,{file: "request.js"});

// Helper Functions
function formatRecord(record){
	var output = '<a class="cplrec" href="http://catalog.cantonpl.org/record=' + record.bnum + '"><span class="cplresultimg">';
	if(record.isbn){
		output += '<img alt="" src="http://www.syndetics.com/index.php?isbn=' + record.isbn[0] + '/SC.GIF&client=cant"/>';
		}
	output += '</span>';
	if(record.title){
		thisTitle = record.title;
		thisTitle = thisTitle.split("/");
		thisTitle = thisTitle[0];
		output += '<span class="cpltitle">' + thisTitle.substr(0,80) + '</span>';
		}
	if(record.author){
		thisAuthor = record.author;
		output += '<span class="cplauthor">' + thisAuthor.substr(0,200) + '</span>';
		}
	output += '</a>';
	return output;
	}

// Events
$("body").click(function(e){
	var clickTarget = $(e.target);
	if(!clickTarget.is("a")){
		clickTarget = clickTarget.parents("a");
		}
	if(clickTarget.attr("href")){chrome.tabs.create({url: clickTarget.attr("href"),selected: false})}
	});

var t = 0;
 $("#searchform").keydown(function(event){
	if(event.keyCode == 40){
		$("a").eq(0).focus();
		}
	else if(event.keyCode == 38 || event.keyCode == 9){}
	else{
		if(t){clearTimeout(t);}
		t = setTimeout(do_request,500);
		}
	});
$("#suggestions").delegate("a", "keydown", function(event){
	if(event.keyCode == 40){
		if($(this).next().eq(0).is("a")){
			$(this).next().eq(0).focus();
			$(this).unbind("keydown");
			}
		return false;
		}
	else if(event.keyCode == 38){
		if($(this).is("a:first-child")){
			$("#argument").focus();
			}
		else{
			$(this).prev().focus();
			}
		$(this).unbind("keydown");
		return false;
		}
	});

$("#searchform").submit(function(){
	do_request();
	return false;
	});
	
chrome.extension.onRequest.addListener(function(request, sender, sendResponse){
	if(request.isbns[0]){
		$('#suggestions').html("<p id=\"loading\" style=\"background:#fff\"><img style=\"vertical-align:-12px;\" src=\"http://www.cantonpl.org/sites/all/themes/zen/cpl/images/loading.gif\" alt=\"loading icon\" /> Searching Page...</p>");
		var isbnsIndex = request.isbns.length - 1;
		$.each(request.isbns,function(i){
			$.getJSON("http://www.cantonpl.org/apis/cat.php?type=i&q=" + request.isbns[i] + "&callback=?",function(data){
				if(data.type != "fail"){
					$("#suggestions").append(formatRecord(data[0]));
					if(i == isbnsIndex){
						if($("#suggestions a").length == 0){
							$("#suggestions").html("Search returned no results.");
							}
						else{$("#loading").remove();}
						}
					}
				});
			});
		}
	});

function do_request(){
	var inputString = $("#argument").val();
	if(inputString.length <= 3){$('#suggestions').html("");}
	else{
		$('#suggestions').html("<p id=\"loading\" style=\"background:#fff\"><img style=\"vertical-align:-12px;\" src=\"http://www.cantonpl.org/sites/all/themes/zen/cpl/images/loading.gif\" alt=\"loading icon\" /> Searching...</p>");
		$.getJSON("http://www.cantonpl.org/apis/cat.php?q=" + inputString + "&type=x&callback=?",function(data){
			if(data.type != "fail"){
				$('#suggestions').html("");
				$.each(data, function(i,item){
					if(i != "type"){
						$("#suggestions").append(formatRecord(item));
						}
					});
				if($(".cplrec").length == 49){$("#suggestions").append('<a href="http://catalog.cantonpl.org/search/X' + escape(inputString) + '" class="more">More &raquo;</a>');}
				}
			else{$("#suggestions").html("Search returned no results.");}
			});
		}
	}
});
</script>
<form id="searchform" method="get" action="http://catalog.cantonpl.org/search/X">
<label for="argument">Search Books, DVDs, more</label>
<input name="SEARCH" id="argument" />
</form>
<div id="suggestions"></div>